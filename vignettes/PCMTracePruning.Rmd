---
title: "Tracing the likelihood calculation of a Gaussian model"
author: "Venelin Mitov"
date: '`r Sys.Date()`'
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Tracing the likelihood calculation of a Gaussian model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: REFERENCES.bib
---

<!--
# Copyright 2016 Venelin Mitov
#
# This file is part of PCMBase.
#
# PCMBase is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# PCMBase is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with PCMBase.  If not, see <http://www.gnu.org/licenses/>.
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ape)
library(PCMBase)
library(data.table)
library(xtable)

options(digits = 2)

# specify either 'html' or 'latex'
tableOutputType <- 'html'
```

```{r tree}
X <- cbind(
  c(0.3, NaN, 1.4), 
  c(0.1, NaN, NA), 
  c(0.2, NaN, 1.2), 
  c(NA, 0.2, 0.2), 
  c(NA, 1.2, 0.4))

colnames(X) <- as.character(1:5)
```

```{r}
treeText <- "((5:0.8,4:1.8)7:1.5,(((3:0.8,2:1.6)6:0.7)8:0.6,1:2.6)9:0.9)0;"
tree <- PCMTree(read.tree(text = treeText))

PCMTreeSetPartRegimes(tree, part.regime = c(`6`=2), setPartition = TRUE, inplace = TRUE)
```


```{r, results='asis'}
model.OU.BM <- MixedGaussian(
  k = nrow(X), 
  modelTypes = MGPMDefaultModelTypes(), 
  mapping = c(6, 2), 
  Sigmae_x = Args_MixedGaussian_MGPMDefaultModelTypes(TRUE)$Sigmae_x)

model.OU.BM <- PCMApplyTransformation(model.OU.BM)
model.OU.BM$X0[] <- c(NA, NA, NA)
model.OU.BM$`1`$H[,,1] <- cbind(
  c(.1, -.7, .6), 
  c(1.3, 2.2, -1.4), 
  c(0.8, 0.2, 0.9))
model.OU.BM$`1`$Theta[] <- c(1.3, -.5, .2)
model.OU.BM$`1`$Sigma_x[,,1] <- cbind(
  c(1, 0, 0), 
  c(1.0, 0.5, 0), 
  c(0.3, -.8, 1))

model.OU.BM$`2`$Sigma_x[,,1] <- cbind(
  c(0.8, 0, 0), 
  c(1, 0.3, 0), 
  c(0.4, 0.5, 0.3))

print(
  PCMTable(model.OU.BM, removeUntransformed = FALSE), 
  xtable = TRUE, type=tableOutputType)
```

```{r}
options(digits=4)
print(PCMLik(X[, tree$tip.label], tree, model.OU.BM))
```

![A tree with five tips and two evolutionary regimes](Fig1.pdf){height="500px" width="100%"}

```{r traceTableR}
traceTable <- PCMLikTrace(X[, tree$tip.label], tree, model.OU.BM)
traceTable[, node:=.I]
setkey(traceTable, i)
pOrder <- c(PCMTreeGetLabels(tree)[tree$edge[PCMTreePostorder(tree), 2]], "0")
options(digits=2)
```

## Omega, Phi, V
```{r omegaPhiVR, results='asis', echo=FALSE}
cat(FormatTableAsLatex(
  traceTable[list(pOrder), list(j, i, t_i, k_i, omega_i, Phi_i, V_i, V_1_i)], 
  type = tableOutputType))
```

## A, b, C, d, E, f
```{r AbCdEfR, results='asis', echo=FALSE}
cat(FormatTableAsLatex(
  traceTable[list(pOrder), list(j, i, k_i, A_i, b_i, C_i, d_i, E_i, f_i)], 
  type = tableOutputType))
```


## L, m, r
```{r LmrR, results='asis', echo=FALSE}
cat(FormatTableAsLatex(
  traceTable[
    list(pOrder), 
    list(
      j, i, X_i, k_i, 
      L_i, m_i, r_i, # `\\hat{X}_i`, `\\ell\\ell_i`,
      `L_{ji}`, `m_{ji}`, `r_{ji}`)], 
  
  type = tableOutputType))
```


# References
