---
title: "The PCMBase Parametrization API"
author: "Venelin Mitov"
date: '`r Sys.Date()`'
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{The PCMBase Parametrization API}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!--
# Copyright 2016 Venelin Mitov
#
# This file is part of PCMBase.
#
# PCMBase is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# PCMBase is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with PCMBase.  If not, see <http://www.gnu.org/licenses/>.
-->

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(abind)
library(PCMBase)
```

# Introduction
Model parameters are the key object of interest in every phylogenetic comparative method. PCMBase provides a powerful interface for specifying and manipulating model parameters. This interface is based on the S3 object system (see http://adv-r.had.co.nz/S3.html for an excellent introduction by Hadley Wickham).

In PCMBase, every model is an object of an S3 class, such as "OU", inheriting from the base S3-class "PCM". A PCM object represents a named list. Each element of that list can be one of the following:

- a global parameter shared by all regimes in the model. For example, this would
be the case for a non-heritable variance-covariance parameter $\Sigma_{e}$ if it is assumed to be the same for every observed species (i.e. tip) in the tree. 
- a local stacked parameter that has a different value for each regime in the model. For example, in an OU model, the selection strength matrix $H$ has a diffent value for each of the $R$ regimes in the model. Therefore, an OU model contains a $k\times k\times R$ array member called "H". The element `H[,,1]` would correspond to regime 1, `H[,,2]` to regime 2, etc. As a second example, the long-term optimum parameter of an OU process is a $k$-dimensional vector $\vec{\theta}_{r}$ for each regime in the model. In an OU model with $R$ regimes, this would be represented by a $k\times R$ array (matrix) called "Theta", such that the vector `Theta[, 1]` corresponds to regime 1. Finally, a local scalar parameter (i.e. a number), would be represented by an $R$-vector.
- a nested PCM object corresponding to a regime. This is the case for a mixed Gaussian phylogenetic model, where different types of Gaussian processes can be acting on different parts of the tree, represented by different regimes. 

# Example: a 3-regime BM model

It can be helpful to examine the structure of a 3-regime bivariate BM model:

```{r}
modelObject <- PCM("BM", k = 2L, regimes = c("a", "b", "c"))

# let's assign some values to the model parameters:
vec <- seq_len(PCMParamCount(modelObject))
PCMParamLoadOrStore(modelObject, vec, offset = 0, load=TRUE)

str(modelObject)
```

Now let's print the model parameters as a table:

```{r, results='asis'}
options(digits = 0)
print(
  PCMTable(modelObject, addTransformed = FALSE, removeUntransformed = FALSE), 
  xtable = TRUE, type='html')
```

We notice that the parameter $\Sigma_{e,u}$ is local for each regime in the model. In the context of a biological application, it can be more appropriate to assume that this parameter is shared by all regimes. Moreover, in many cases, it can be necessary to assume that the matrix $\Sigma_{e,u}$ is diagonal, meaning that the non-heritable component for any of the traits is is uncorrelated with the non-heritable components for the other traits. To specify this, first, we look at the list of available BM model types. 

```{r}
PCMModels(parentClass = "BM")
```

We notice that the above list does not contain a BM model type with a global parameter `Sigmae_x`. This means that the S3 methods for such a model parametrization have not yet been generated and loaded in the memory. The function `PCMListParameterizations` returns a named list, where each named element is a list of the possible S3 class assignments for the corresponding parameter. So, let's see what are the available S3 classes for the parameter `Sigmae_x` of a BM model:

```{r}
PCMListParameterizations(structure(0.0, class="BM"))$Sigmae_x
```

We notice that the 5th element above contains "_Diagonal" and "_Global" in the list of S3-classes. We proceed to generate all BM parametrizations with this S3-class assignment for the parameter `Sigmae_x`.

```{r}
# 1. Filter the list of parametrizations to avoid generating too many S3 methods.
# (note that we could do the same type of filtering for the other parameters).
listParameterizationsBM <- PCMListParameterizations(structure(0.0, class="BM"))
listParameterizationsBM$Sigmae_x <- listParameterizationsBM$Sigmae_x[5]
  
# 2. Generate a table of parametrizations for this list:
dtParameterizations <- PCMTableParameterizations(
  structure(0.0, class="BM"), listParameterizations = listParameterizationsBM)

print(dtParameterizations)

# 3. Generate the parametrizations (optionally, we could select a subset of the
# rows in the data.table)
PCMGenerateParameterizations(structure(0.0, class="BM"), 
                             tableParameterizations = dtParameterizations[])
```

Now the list of BM-models contains the generated model types with global diagonal  `Sigmae_x`:

```{r}
PCMModels("BM")
```

```{r, results='asis'}
BMModelGlobalSigmae <- paste0(
  "BM" , 
  "__Global_X0", 
  "__UpperTriangularWithDiagonal_WithNonNegativeDiagonal_Sigma_x", 
  "__Diagonal_WithNonNegativeDiagonal_Global_Sigmae_x")

modelObject2 <- PCM(BMModelGlobalSigmae, k = 2, regimes = c("a", "b", "c"))
vec <- seq_len(PCMParamCount(modelObject2))
PCMParamLoadOrStore(modelObject2, vec, offset = 0, load=TRUE)
    
print(
  PCMTable(modelObject2, addTransformed = FALSE, removeUntransformed = FALSE), 
  xtable = TRUE, type='html')                 
```


