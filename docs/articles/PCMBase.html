<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting Started with the PCMBase R-package • PCMBase</title>
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.1/clipboard.min.js" integrity="sha256-hIvIxeqhGZF+VVeM55k0mJvWpQ6gTkWk3Emc+NmowYA=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with the PCMBase R-package">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PCMBase</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/PCMBase.html">Get started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/PCMParam.html">The PCMBase Parametrization API</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Getting Started with the PCMBase R-package</h1>
                        <h4 class="author">Venelin Mitov</h4>
            
            <h4 class="date">2018-11-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/venelin/PCMBase/blob/master/vignettes/PCMBase.Rmd"><code>vignettes/PCMBase.Rmd</code></a></small>
      <div class="hidden name"><code>PCMBase.Rmd</code></div>

    </div>

    
    
<div id="data" class="section level1">
<h1 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h1>
<p>The input data for the phylogenetic comparative methods covered in the PCMBase package consists of a phylogenetic tree of <span class="math inline">\(N\)</span> tips and a <span class="math inline">\(k\times N\)</span> matrix, <span class="math inline">\(X\)</span> of observed trait-values, where <span class="math inline">\(k\)</span> is the number of traits. The matrix <span class="math inline">\(X\)</span> can contain <code>NA</code>s corresponding to missing measurements and <code>NaN</code>’s corresponding to non-existing traits for some of the tips.</p>
</div>
<div id="models" class="section level1">
<h1 class="hasAnchor">
<a href="#models" class="anchor"></a>Models</h1>
<p>A <em>model</em> is defined by a set of parameters and a rule stating how these parameters should be fit to the data. For example, a multivariate phylogenetic Ornstein-Uhlenbeck mixed model has the following parameters:</p>
<ul>
<li>
<code>X0</code> : a <span class="math inline">\(k\)</span>-vector of initial values;</li>
<li>
<code>H</code> : a <span class="math inline">\(k\times k\)</span> matrix denoting the selection strength of the process;</li>
<li>
<code>Theta</code> : a <span class="math inline">\(k\)</span>-vector of long-term optimal trait values;</li>
<li>
<code>Sigma</code> : a <span class="math inline">\(k\times k\)</span> matrix denoting the stochastic drift variance-covariances;</li>
<li>
<code>Sigmae</code> : a <span class="math inline">\(k\times k\)</span> matrix denoting the non-genetic (non-heritable) variance covariance;</li>
</ul>
<p>The rule defining how the above OU-parameters should be fit to the data is defined by the multivariate OU Gaussian distribution, as described in (insert reference); Currently, PCMBase supports multivariate Gaussian models satisfying the following two conditions:</p>
<ol style="list-style-type: lower-alpha">
<li>the mean of the underlying stochastic process at the end of a time interval on a branch of the tree depends linearly on the ancestral value at the beginning of the branch;</li>
<li>the variance-covariance matrix of the stochastic process after a time interval does not depend on the ancestral value.</li>
</ol>
<p>In PCMBase, models are specified as S3 objects, i.e. ordinary R-lists with a class attribute. The base S3 class of all models is called <code>"PCM"</code>, which is inherited by more specific model-classes. Let us create a BM PCM for two traits:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">modelBM &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCM.html">PCM</a></span>(<span class="dt">model =</span> <span class="st">"BM"</span>, <span class="dt">k =</span> <span class="dv">2</span>)</code></pre></div>
<p>Printing the model object shows a short verbal description, the S3-class, the number of traits, k, the number of numerical parameters of the model, p, the model regimes and the current values of the parameters for each regime (more on regimes in the next sub-section):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">modelBM</code></pre></div>
<pre><code>## Brownian motion model
## S3 class: BM, GaussianPCM, PCM; k=2; p=8; regimes: 1. Parameters/sub-models:
## X0 (VectorParameter, _Global, numeric; trait values at the root):
## [1] 0 0
## Sigma_x (MatrixParameter, _UpperTriangularWithDiagonal, _WithNonNegativeDiagonal; Choleski factor of the unit-time variance rate):
## , , 1
## 
##      [,1] [,2]
## [1,]    0    0
## [2,]    0    0
## 
## Sigmae_x (MatrixParameter, _UpperTriangularWithDiagonal, _WithNonNegativeDiagonal; Choleski factor of the non-heritable variance or the variance of the measurement error):
## , , 1
## 
##      [,1] [,2]
## [1,]    0    0
## [2,]    0    0
## 
## </code></pre>
<p>One may wonder why in the above description, p = 8 instead of 10 (see also <code><a href="../reference/PCMParamCount.html">?PCMParamCount</a></code>). The reason is that both, the matrix Sigma and the matrix Sigmae, are symmetric matrices and their matching off-diagonal elements are counted only one time.</p>
<div id="model-regimes" class="section level2">
<h2 class="hasAnchor">
<a href="#model-regimes" class="anchor"></a>Model regimes</h2>
<p>Model <em>regimes</em> are different models associated with different branches of the phylogenetic tree. This is a powerful concept allowing to model different evolutionary modes on different lineages on the tree. Let us create a 2-trait BM model with two regimes called a and b:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">modelBM.ab &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCM.html">PCM</a></span>(<span class="st">"BM"</span>, <span class="dt">k =</span> <span class="dv">2</span>, <span class="dt">regimes =</span> <span class="kw">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>))
modelBM.ab</code></pre></div>
<pre><code>## Brownian motion model
## S3 class: BM, GaussianPCM, PCM; k=2; p=14; regimes: a, b. Parameters/sub-models:
## X0 (VectorParameter, _Global, numeric; trait values at the root):
## [1] 0 0
## Sigma_x (MatrixParameter, _UpperTriangularWithDiagonal, _WithNonNegativeDiagonal; Choleski factor of the unit-time variance rate):
## , , a
## 
##      [,1] [,2]
## [1,]    0    0
## [2,]    0    0
## 
## , , b
## 
##      [,1] [,2]
## [1,]    0    0
## [2,]    0    0
## 
## Sigmae_x (MatrixParameter, _UpperTriangularWithDiagonal, _WithNonNegativeDiagonal; Choleski factor of the non-heritable variance or the variance of the measurement error):
## , , a
## 
##      [,1] [,2]
## [1,]    0    0
## [2,]    0    0
## 
## , , b
## 
##      [,1] [,2]
## [1,]    0    0
## [2,]    0    0
## 
## </code></pre>
<p>Now, we can set some different values for the parameters of the model we’ve just created. First, let us specify an initial value vector different from the default 0-vector:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">modelBM.ab<span class="op">$</span>X0[] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">2</span>)</code></pre></div>
<p>X0 is defined as a parameter with S3 class <code>class(modelBM.ab$X0)</code>. This specifies that <code>X0</code> is global vector parameter shared by all model regimes. This is also the reason, why the number of parameters is not the double of the number of parameters in the first model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/PCMParamCount.html">PCMParamCount</a></span>(modelBM)</code></pre></div>
<pre><code>## [1] 8</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/PCMParamCount.html">PCMParamCount</a></span>(modelBM.ab)</code></pre></div>
<pre><code>## [1] 14</code></pre>
<p>The other parameters, Sigma and Sigmae are local for each regime:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># in regime 'a' the traits evolve according to two independent BM processes (starting from the global vecto X0).</span>
modelBM.ab<span class="op">$</span>Sigma_x[,, <span class="st">"a"</span>] &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="fl">1.6</span>, <span class="dv">0</span>),
                                  <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">2.4</span>))
modelBM.ab<span class="op">$</span>Sigmae_x[,, <span class="st">"a"</span>] &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(.<span class="dv">1</span>, <span class="dv">0</span>),
                                   <span class="kw">c</span>(<span class="dv">0</span>, .<span class="dv">4</span>))
<span class="co"># in regime 'b' there is a correlation between the traits</span>
modelBM.ab<span class="op">$</span>Sigma_x[,, <span class="st">"b"</span>] &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="fl">1.6</span>, .<span class="dv">8</span>),
                                  <span class="kw">c</span>(.<span class="dv">8</span>, <span class="fl">2.4</span>))
modelBM.ab<span class="op">$</span>Sigmae_x[,, <span class="st">"b"</span>] &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(.<span class="dv">1</span>, <span class="dv">0</span>),
                                   <span class="kw">c</span>(<span class="dv">0</span>, .<span class="dv">4</span>))</code></pre></div>
<p>The above way of setting values for model parameters, while human readable, is not handy during model fitting procedures, such as likelihood maximization. Thus, there is another way to set (or get) the model parameter values from a numerical vector:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">param &lt;-<span class="st"> </span><span class="kw">double</span>(<span class="kw"><a href="../reference/PCMParamCount.html">PCMParamCount</a></span>(modelBM.ab))

<span class="co"># load the current model parameters into param</span>
<span class="kw"><a href="../reference/PCMParamLoadOrStore.html">PCMParamLoadOrStore</a></span>(modelBM.ab, param, <span class="dt">offset=</span><span class="dv">0</span>, <span class="dt">load=</span><span class="ot">FALSE</span>)</code></pre></div>
<pre><code>## [1] 14</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(param)</code></pre></div>
<pre><code>##  [1] 5.0 2.0 1.6 0.0 2.4 1.6 0.8 2.4 0.1 0.0 0.4 0.1 0.0 0.4</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># modify slightly the model parameters</span>
param2 &lt;-<span class="st"> </span><span class="kw">jitter</span>(param)

<span class="kw">print</span>(param2)</code></pre></div>
<pre><code>##  [1]  5.014382755  2.008217233  1.612403441 -0.005753739  2.380490553
##  [6]  1.608073459  0.798419400  2.411975167  0.115953306 -0.019154019
## [11]  0.406794558  0.093007691 -0.009950226  0.395757452</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># set the new parameter vector</span>
<span class="kw"><a href="../reference/PCMParamLoadOrStore.html">PCMParamLoadOrStore</a></span>(modelBM.ab, param2, <span class="dt">offset =</span> <span class="dv">0</span>, <span class="dt">load=</span><span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] 14</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(modelBM.ab)</code></pre></div>
<pre><code>## Brownian motion model
## S3 class: BM, GaussianPCM, PCM; k=2; p=14; regimes: a, b. Parameters/sub-models:
## X0 (VectorParameter, _Global, numeric; trait values at the root):
## [1] 5.014383 2.008217
## Sigma_x (MatrixParameter, _UpperTriangularWithDiagonal, _WithNonNegativeDiagonal; Choleski factor of the unit-time variance rate):
## , , a
## 
##          [,1]         [,2]
## [1,] 1.612403 -0.005753739
## [2,] 0.000000  2.380490553
## 
## , , b
## 
##          [,1]      [,2]
## [1,] 1.608073 0.7984194
## [2,] 0.800000 2.4119752
## 
## Sigmae_x (MatrixParameter, _UpperTriangularWithDiagonal, _WithNonNegativeDiagonal; Choleski factor of the non-heritable variance or the variance of the measurement error):
## , , a
## 
##           [,1]        [,2]
## [1,] 0.1159533 -0.01915402
## [2,] 0.0000000  0.40679456
## 
## , , b
## 
##            [,1]         [,2]
## [1,] 0.09300769 -0.009950226
## [2,] 0.00000000  0.395757452
## 
## </code></pre>
</div>
</div>
<div id="simulating-data-on-a-phylogenetic-tree" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-data-on-a-phylogenetic-tree" class="anchor"></a>Simulating data on a phylogenetic tree</h1>
<p>The first functionality of the PCMBase package is to provide an easy way to simulate multiple trait data on a tree under a given (possibly multiple regime) PCM.</p>
<p>For this example, first we simulate a birth death tree with two regimes “a” and “b” using the <code>phytools</code> R-package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># make results reproducible</span>
<span class="kw">set.seed</span>(<span class="dv">2</span>)

<span class="co"># number of regimes</span>
R &lt;-<span class="st"> </span><span class="dv">2</span>

<span class="co"># number of extant tips</span>
N &lt;-<span class="st"> </span><span class="dv">100</span>

tree.a &lt;-<span class="st"> </span><span class="kw">rtree</span>(<span class="dt">n=</span>N)
<span class="kw"><a href="../reference/PCMTreeSetLabels.html">PCMTreeSetLabels</a></span>(tree.a)
<span class="kw"><a href="../reference/PCMTreeSetDefaultRegime.html">PCMTreeSetDefaultRegime</a></span>(tree.a, <span class="dt">regime =</span> <span class="st">"a"</span>)

lstDesc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMTreeListDescendants.html">PCMTreeListDescendants</a></span>(tree.a)
splitNode &lt;-<span class="st"> </span><span class="kw">names</span>(lstDesc)[<span class="kw">which</span>(<span class="kw">sapply</span>(lstDesc, length) <span class="op">&gt;</span><span class="st"> </span>N<span class="op">/</span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">sapply</span>(lstDesc, length) <span class="op">&lt;</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>N<span class="op">/</span><span class="dv">3</span>)][<span class="dv">1</span>]

tree.ab &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMTreeInsertSingletons.html">PCMTreeInsertSingletons</a></span>(tree.a, <span class="dt">nodes =</span> <span class="kw">as.integer</span>(splitNode), 
                                   <span class="dt">positions =</span> <span class="kw"><a href="../reference/PCMTreeGetBranchLength.html">PCMTreeGetBranchLength</a></span>(tree.a, <span class="kw">as.integer</span>(splitNode))<span class="op">/</span><span class="dv">2</span>)
<span class="kw"><a href="../reference/PCMTreeSetRegimes.html">PCMTreeSetRegimes</a></span>(tree.ab, <span class="dt">nodes =</span> splitNode, <span class="dt">regimes =</span> <span class="kw">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>), <span class="dt">inplace =</span> <span class="ot">TRUE</span>)

<span class="co"># Currently this is causing a failure of the pkgdown::build_site(), so we use the </span>
<span class="co"># ape's tree-plotting function</span>
<span class="co"># PCMTreePlot(tree.ab)</span>

palette &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMColorPalette.html">PCMColorPalette</a></span>(<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>))
<span class="kw">plot</span>(tree.ab, <span class="dt">show.tip.label=</span><span class="ot">FALSE</span>, <span class="dt">edge.color =</span> palette[tree.ab<span class="op">$</span>edge.regime])</code></pre></div>
<p><img src="PCMBase_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Now we can simulate data on the tree using the modelBM.ab$X0 as a starting value:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">traits &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMSim.html">PCMSim</a></span>(tree.ab, modelBM.ab, modelBM.ab<span class="op">$</span>X0)</code></pre></div>
</div>
<div id="calculating-likelihoods" class="section level1">
<h1 class="hasAnchor">
<a href="#calculating-likelihoods" class="anchor"></a>Calculating likelihoods</h1>
<p>Calculating a model likelihood for a given tree and data is the other key functionality of the PCMBase package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/PCMLik.html">PCMLik</a></span>(traits, tree.ab, modelBM.ab)</code></pre></div>
<pre><code>## [1] -409.5303
## attr(,"X0")
## [1] 5.014383 2.008217
## attr(,"class")
## [1] "VectorParameter" "_Global"         "numeric"        
## attr(,"description")
## [1] "trait values at the root"</code></pre>
<p>For faster and repeated likelihood evaluation, I recommend creating a likelihood function for a given data, tree and model object. Passing this function object to <code>optim</code> would save the need for pre-processing the data and tree at every likelihood evaluation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># a function of a numerical parameter vector:</span>
likFun &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMCreateLikelihood.html">PCMCreateLikelihood</a></span>(traits, tree.ab, modelBM.ab)

<span class="kw">likFun</span>(param2)</code></pre></div>
<pre><code>## [1] -409.5303
## attr(,"X0")
## [1] 5.014383 2.008217
## attr(,"class")
## [1] "VectorParameter" "_Global"         "numeric"        
## attr(,"description")
## [1] "trait values at the root"</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#data">Data</a></li>
      <li>
<a href="#models">Models</a><ul class="nav nav-pills nav-stacked">
<li><a href="#model-regimes">Model regimes</a></li>
      </ul>
</li>
      <li><a href="#simulating-data-on-a-phylogenetic-tree">Simulating data on a phylogenetic tree</a></li>
      <li><a href="#calculating-likelihoods">Calculating likelihoods</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Venelin Mitov.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
