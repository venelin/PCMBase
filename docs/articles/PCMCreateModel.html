<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creating a Custom Model in the PCMBase Framework • PCMBase</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Creating a Custom Model in the PCMBase Framework">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-129563006-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129563006-3');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PCMBase</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.12</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/PCMBase.html">Get started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/PCMParam.html">The PCMBase Parametrization API</a>
    </li>
    <li>
      <a href="../articles/PCMTracePruning.html">Tracing the likelihood calculation of a Gaussian model</a>
    </li>
    <li>
      <a href="../articles/PCMCreateModel.html">Creating a Custom Model in the PCMBase Framework</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Creating a Custom Model in the PCMBase Framework</h1>
                        <h4 class="author">Krzysztof Bartoszek, Venelin Mitov</h4>
            
            <h4 class="date">2021-06-05</h4>
      
      
      <div class="hidden name"><code>PCMCreateModel.Rmd</code></div>

    </div>

    
    
<!--
# Copyright 2016-2019 Venelin Mitov, Krzysztof Bartoszek
#
# This file is part of PCMBase.
#
# PCMBase is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# PCMBase is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with PCMBase.  If not, see <http://www.gnu.org/licenses/>.
-->
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The PCMBase package is designed as a computational engine to calculate the likelihood for a user specified model evolving on a phylogenetic tree. The package comes with some pre-implemented models, e.g. Brownian Motion or Ornstein-Uhlenbeck, both allowing for multivariate correlated evolution. However, the mathematical theory behind the method for calculating the likelihood <span class="citation">(Mitov et al. 2019)</span> is not limited to these two models. In fact any stochastic process that belongs to the so-called GLInv family of models is implementable in PCMBase. From a mathematical perspective one needs to be able to implement functions that calculate the compound parameters <span class="math inline">\(\vec{\omega}\)</span>, <span class="math inline">\(\mathbf{\Phi}\)</span> and <span class="math inline">\(\mathbf{V}\)</span>. Furthermore, from the implementation side one has to be able to handle the model defining parameters (default values, allowable parametrizations, etc.).</p>
<p>PCMBase’s interface is based on the S3 object system (an excellent introduction by Hadley Wickham is available at <a href="http://adv-r.had.co.nz/S3.html" class="uri">http://adv-r.had.co.nz/S3.html</a>). Each implemented model will be an S3 object and below we will describe how users can implement new model classes by themselves.</p>
</div>
<div id="brownian-motion-with-drift" class="section level1">
<h1 class="hasAnchor">
<a href="#brownian-motion-with-drift" class="anchor"></a>Brownian motion with drift</h1>
<p>We will show how to create one’s own model class with the example of Brownian motion with drift. The model is a simple generalization of the Brownian motion model by including a deterministic drift. It is defined by the stochastic differential equation (SDE) <span class="math display">\[d\vec{X}(t) = \vec{h} dt + \mathbf{\Sigma}_{x} d W(t),\]</span> where <span class="math inline">\(W(t)\)</span> is the standard Wiener process, <span class="math inline">\(\vec{h}\)</span> is a constant <span class="math inline">\(k\)</span>-dimensional vector and <span class="math inline">\(\mathbf{\Sigma}_{x}\)</span> is a an upper-triangular matrix with positive diagonal elements. Setting <span class="math inline">\(\vec{h}=\vec{0}\)</span> reduces the model to a Brownian motion process. The expectation of the process at any time <span class="math inline">\(t\)</span>, given initial value at <span class="math inline">\(t=0\)</span> is <span class="math inline">\(E[\vec{X}(t)] = \vec{X}(0)+t\vec{h}\)</span> and the variance is <span class="math inline">\(Var[\vec{X}(t)] = t\mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}\)</span>. Here, Based on this we can calculate the the compound parameters <span class="math inline">\(\vec{\omega}\)</span>, <span class="math inline">\(\mathbf{\Phi}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> defining the model in the GLInv family (Eq. 30, <span class="citation">(Mitov et al. 2019)</span>) <span class="math display">\[
\vec{\omega} = \vec{h}t,
\]</span> <span class="math display">\[
\mathbf{\Phi} = \mathbf{I},
\]</span> <span class="math display">\[
\mathbf{V} = \mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}t.
\]</span> The above equations hold for any internal node without measured trait data. For any tip or internal node with available trait values the variance is given by <span class="math display">\[
\mathbf{V} = \mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}t +  \mathbf{\Sigma}_{e,x}\mathbf{\Sigma}_{e,x}^{T} + \mathbf{S}_{e,i}\mathbf{S}_{e,i}^{T},
\]</span> where <span class="math inline">\(\mathbf{\Sigma}_{e,x}\)</span> is a regime-specific or global upper triangular matrix parameter with a non-negative diagonal specifying an unknown non-phylogenetic component of the trait variance covariance matrix (e.g. an unknown measurement error), and <span class="math inline">\(\mathbf{S}_{e,i}\)</span> is a species-specific upper triangular matrix with a non-negative diagonal specifying a known standard error of the measured trait data for each species.</p>
</div>
<div id="a-pcmbase-class-for-brownian-motion-with-drift" class="section level1">
<h1 class="hasAnchor">
<a href="#a-pcmbase-class-for-brownian-motion-with-drift" class="anchor"></a>A PCMBase class for Brownian motion with drift</h1>
<p>We will now show how to implement the Brownian motion with drift model in a class called “BM_drift that inherits from the”GaussianPCM" and “PCM” classes. It is easiest if one takes an .R file from the PCMBase package that already implements a model class and then modifies it accordingly. We will work here with the BM.R file (that implements the BM model). We need to redefine the generic functions of the “PCM” and “GaussianPCM” classes to suit the Brownian motion with drift model. We remind the reader that the function name is composed of two parts separated by the dot. The first part is the generic function, the second the name of the class in which it is implemented. For example <code>PCMCond.BM_drift</code> is the <code>PCMCond</code> function’s instance in the “BM_drift” class.</p>
<ul>
<li>
<code>PCMParentClasses.BM_drift</code> : function returning the parental classes. of “BM_drift”:</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>PCMParentClasses.BM_drift &lt;-<span class="st"> </span><span class="cf">function</span>(model) {</span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"GaussianPCM"</span>, <span class="st">"PCM"</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a>}</span></code></pre></div>
<ul>
<li>
<code>PCMDescribe.BM_drift</code> : function returning a custom description of the model.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>PCMDescribe.BM_drift &lt;-<span class="st"> </span><span class="cf">function</span>(model, ...) {</span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="st">"Brownian motion model with drift"</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>}</span></code></pre></div>
<ul>
<li>
<code>PCMCond.BM_drift</code> : the key function when implementing a new model class. This function returns a list with functions for calculating the <span class="math inline">\(\vec{\omega}\)</span>, <span class="math inline">\(\mathbf{\Phi}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> compound parameters that define the conditional distribution of the daughter node given the value of the trait at its parent node (<span class="math inline">\(\vec{x}_{parent}\)</span>. Following <span class="citation">(Mitov et al. 2019)</span> we know that in the GLInv family a daughter node conditional on its parent is normally distributed with expectation <span class="math inline">\(\vec{\omega}+\mathbf{\Phi}\vec{x}_{parent}\)</span> and variance-covariance matrix <span class="math inline">\(\mathbf{V}\)</span>. In particular the <span class="math inline">\(\vec{\omega}\)</span>, <span class="math inline">\(\mathbf{\Phi}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> compound parameters can depend on time (i.e. the length of the branch from the parental to the daughter node). In the case of the BM with drift model the <span class="math inline">\(\vec{\omega}=t\cdot \vec{h}\)</span>, <span class="math inline">\(\mathbf{\Phi}\)</span> is the identity matrix and <span class="math inline">\(\mathbf{V}\)</span> is the same as in the Brownian motion model (which in itself is a limit of the OU model, hence the reuse of the PCMConcVOU function).</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>PCMCond.BM_drift &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb3-2"><a href="#cb3-2"></a>  tree, model, <span class="dt">r =</span> <span class="dv">1</span>, <span class="dt">metaI =</span> <span class="kw"><a href="../reference/PCMInfo.html">PCMInfo</a></span>(<span class="ot">NULL</span>, tree, model, <span class="dt">verbose =</span> verbose),</span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="dt">verbose=</span><span class="ot">FALSE</span>) {</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>  </span>
<span id="cb3-6"><a href="#cb3-6"></a>  Sigma_x &lt;-<span class="st"> </span><span class="cf">if</span>(<span class="kw"><a href="../reference/PCMParamType.html">is.Global</a></span>(model<span class="op">$</span>Sigma_x)){<span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(model<span class="op">$</span>Sigma_x)}</span>
<span id="cb3-7"><a href="#cb3-7"></a>         <span class="cf">else</span>{<span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(model<span class="op">$</span>Sigma_x[,, r])}</span>
<span id="cb3-8"><a href="#cb3-8"></a>  Sigma &lt;-<span class="st"> </span>Sigma_x <span class="op">%*%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(Sigma_x)</span>
<span id="cb3-9"><a href="#cb3-9"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(model<span class="op">$</span>Sigmae_x)) {</span>
<span id="cb3-10"><a href="#cb3-10"></a>    Sigmae_x &lt;-<span class="st"> </span><span class="cf">if</span>(<span class="kw"><a href="../reference/PCMParamType.html">is.Global</a></span>(model<span class="op">$</span>Sigmae_x)){<span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(model<span class="op">$</span>Sigmae_x)}</span>
<span id="cb3-11"><a href="#cb3-11"></a>        <span class="cf">else</span>{<span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(model<span class="op">$</span>Sigmae_x[,,r])}</span>
<span id="cb3-12"><a href="#cb3-12"></a>    Sigmae &lt;-<span class="st"> </span>Sigmae_x <span class="op">%*%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(Sigmae_x)</span>
<span id="cb3-13"><a href="#cb3-13"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-14"><a href="#cb3-14"></a>    Sigmae &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>  }</span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(model<span class="op">$</span>h_drift)) { </span>
<span id="cb3-18"><a href="#cb3-18"></a>    h_drift &lt;-<span class="st"> </span><span class="cf">if</span>(<span class="kw"><a href="../reference/PCMParamType.html">is.Global</a></span>(model<span class="op">$</span>h_drift)) <span class="kw"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(model<span class="op">$</span>h_drift) <span class="cf">else</span> model<span class="op">$</span>h_drift[, r]</span>
<span id="cb3-19"><a href="#cb3-19"></a>  }<span class="cf">else</span>{</span>
<span id="cb3-20"><a href="#cb3-20"></a>    h_drift &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">0</span>,<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(Sigma_x))</span>
<span id="cb3-21"><a href="#cb3-21"></a>  }</span>
<span id="cb3-22"><a href="#cb3-22"></a></span>
<span id="cb3-23"><a href="#cb3-23"></a>  V &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMCondVOU.html">PCMCondVOU</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(Sigma), <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(Sigma)), Sigma, Sigmae)</span>
<span id="cb3-24"><a href="#cb3-24"></a>  omega &lt;-<span class="st"> </span><span class="cf">function</span>(t, edgeIndex, metaI) {</span>
<span id="cb3-25"><a href="#cb3-25"></a>    t<span class="op">*</span>h_drift</span>
<span id="cb3-26"><a href="#cb3-26"></a>  }</span>
<span id="cb3-27"><a href="#cb3-27"></a>  Phi &lt;-<span class="st"> </span><span class="cf">function</span>(t, edgeIndex, metaI, <span class="dt">e_Ht =</span> <span class="ot">NULL</span>) {</span>
<span id="cb3-28"><a href="#cb3-28"></a>    <span class="kw"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(Sigma))</span>
<span id="cb3-29"><a href="#cb3-29"></a>  }</span>
<span id="cb3-30"><a href="#cb3-30"></a>  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">omega =</span> omega, <span class="dt">Phi =</span> Phi, <span class="dt">V =</span> V)</span>
<span id="cb3-31"><a href="#cb3-31"></a>}</span></code></pre></div>
<ul>
<li>
<code>PCMDescribeParameters.BM_drift</code> : a function that returns a list with a custom description of each model parameter.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>PCMDescribeParameters.BM_drift &lt;-<span class="st"> </span><span class="cf">function</span>(model, ...) {</span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="dt">X0 =</span> <span class="st">"trait values at the root"</span>,</span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="dt">h_drift =</span> <span class="st">"drift vector modifying the expectation"</span>,</span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="dt">Sigma_x =</span> <span class="st">"Upper triangular factor of the unit-time variance rate"</span>,</span>
<span id="cb4-6"><a href="#cb4-6"></a>    <span class="dt">Sigmae_x =</span> <span class="st">"Upper triangular factor of the non-heritable variance </span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="st">        or the variance of the measurement error"</span>)</span>
<span id="cb4-8"><a href="#cb4-8"></a>}</span></code></pre></div>
<ul>
<li>
<code>PCMListParameterizations.BM_drift</code> : a function that returns all possible parametrizations for the implemented model class. These parametrizations correspond to how each parameter defining the model can be parametrized. Probably from the perspective of just calculating the likelihood given some parameters this function does not seem that useful. However, one should not forget that PCMBase is designed to be a computational engine providing the likelihood that will be optimized over some other code. Here, <span class="math inline">\(\vec{X}(0)\)</span> and <span class="math inline">\(\vec{h}\)</span> are vectors (i.e. “VectorParameter”). The "_AllEqual" parametrization means all the entries of the vector should be equal. "_Global" means that it is the same for all regimes (notice that <span class="math inline">\(\vec{X}(0)\)</span> is the value at the root, so it has to be common for all), "_Omitted" means not present (for <span class="math inline">\(\vec{h}\)</span> this means that the model will correspond to a Brownian motion with <span class="math inline">\(0\)</span> drift). Finally "_Fixed" means that the parameter is “known”, i.e. it is not to be optimized over. Matrix parametrizations are more involved. For example one will not optimize over a covariance matrix but e.g. over its decomposition as a product of an upper triangular matrix with its transpose. Here we just have the <span class="math inline">\(\mathbf{\Sigma}_{x}\)</span> and <span class="math inline">\(\mathbf{\Sigma}_{e,x}\)</span> matrices (however see the “OU” class for more involved cases with the <span class="math inline">\(H\)</span> matrix). Both of them enter the likelihood (through <span class="math inline">\(\mathbf{V}\)</span>) as a product of themselves and their transposition i.e.  <span class="math inline">\(\mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}\)</span> so decomposition into a triangular matrix (with non-negative diagonal) suffices for unique identification of the matrix. Note that this parametrization guarantees that the matrix <span class="math inline">\(\mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}\)</span> is a symmetric semi- positive-definite matrix. If the diagonal elements of <span class="math inline">\(\mathbf{\Sigma}_{x}\)</span> are strictly non-zero <span class="math inline">\(\mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}\)</span> will be positive-definite. A detailed description of the different possible parametrizations is given in the <a href="https://venelin.github.io/PCMBase/articles/PCMParam.html">The PCMBase Parametrization API</a> guide.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>PCMListParameterizations.BM_drift &lt;-<span class="st"> </span><span class="cf">function</span>(model, ...) {</span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb5-3"><a href="#cb5-3"></a>    <span class="dt">X0 =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb5-4"><a href="#cb5-4"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"VectorParameter"</span>, <span class="st">"_Global"</span>),</span>
<span id="cb5-5"><a href="#cb5-5"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"VectorParameter"</span>, <span class="st">"_Fixed"</span>, <span class="st">"_Global"</span>),</span>
<span id="cb5-6"><a href="#cb5-6"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"VectorParameter"</span>, <span class="st">"_AllEqual"</span>, <span class="st">"_Global"</span>),</span>
<span id="cb5-7"><a href="#cb5-7"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"VectorParameter"</span>, <span class="st">"_Omitted"</span>)),</span>
<span id="cb5-8"><a href="#cb5-8"></a>    <span class="dt">h_drift =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(     </span>
<span id="cb5-9"><a href="#cb5-9"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"VectorParameter"</span>),</span>
<span id="cb5-10"><a href="#cb5-10"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"VectorParameter"</span>, <span class="st">"_Fixed"</span>),</span>
<span id="cb5-11"><a href="#cb5-11"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"VectorParameter"</span>, <span class="st">"_AllEqual"</span>),</span>
<span id="cb5-12"><a href="#cb5-12"></a>       <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"VectorParameter"</span>, <span class="st">"_Omitted"</span>)),</span>
<span id="cb5-13"><a href="#cb5-13"></a>       </span>
<span id="cb5-14"><a href="#cb5-14"></a>    <span class="dt">Sigma_x =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb5-15"><a href="#cb5-15"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_UpperTriangularWithDiagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>),</span>
<span id="cb5-16"><a href="#cb5-16"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_Diagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>),</span>
<span id="cb5-17"><a href="#cb5-17"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_ScalarDiagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>)),</span>
<span id="cb5-18"><a href="#cb5-18"></a></span>
<span id="cb5-19"><a href="#cb5-19"></a>    <span class="dt">Sigmae_x =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb5-20"><a href="#cb5-20"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_UpperTriangularWithDiagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>),</span>
<span id="cb5-21"><a href="#cb5-21"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_Diagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>),</span>
<span id="cb5-22"><a href="#cb5-22"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_ScalarDiagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>),</span>
<span id="cb5-23"><a href="#cb5-23"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_UpperTriangularWithDiagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>, <span class="st">"_Global"</span>),</span>
<span id="cb5-24"><a href="#cb5-24"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_Diagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>, <span class="st">"_Global"</span>),</span>
<span id="cb5-25"><a href="#cb5-25"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_ScalarDiagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>, <span class="st">"_Global"</span>),</span>
<span id="cb5-26"><a href="#cb5-26"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_Omitted"</span>))</span>
<span id="cb5-27"><a href="#cb5-27"></a>  )</span>
<span id="cb5-28"><a href="#cb5-28"></a>}</span></code></pre></div>
<ul>
<li>
<code>PCMListDefaultParameterizations.BM_drift</code> : this function is optional to define but can be useful if only a subset of the parametrizations defined in the <code>PCMListParametrizations</code> function will actually be used in practice.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>PCMListDefaultParameterizations.BM_drift &lt;-<span class="st"> </span><span class="cf">function</span>(model, ...) {</span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb6-3"><a href="#cb6-3"></a>    <span class="dt">X0 =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb6-4"><a href="#cb6-4"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"VectorParameter"</span>, <span class="st">"_Global"</span>),</span>
<span id="cb6-5"><a href="#cb6-5"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"VectorParameter"</span>, <span class="st">"_Omitted"</span>)</span>
<span id="cb6-6"><a href="#cb6-6"></a>    ),</span>
<span id="cb6-7"><a href="#cb6-7"></a>    <span class="dt">h_drift =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(     </span>
<span id="cb6-8"><a href="#cb6-8"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"VectorParameter"</span>)),</span>
<span id="cb6-9"><a href="#cb6-9"></a>       </span>
<span id="cb6-10"><a href="#cb6-10"></a>    <span class="dt">Sigma_x =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb6-11"><a href="#cb6-11"></a>        <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_UpperTriangularWithDiagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>),</span>
<span id="cb6-12"><a href="#cb6-12"></a>        <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_Diagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>),</span>
<span id="cb6-13"><a href="#cb6-13"></a>        <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_ScalarDiagonal"</span>, <span class="st">"_WithNonNegativeDiagonal"</span>)</span>
<span id="cb6-14"><a href="#cb6-14"></a>      ),</span>
<span id="cb6-15"><a href="#cb6-15"></a></span>
<span id="cb6-16"><a href="#cb6-16"></a>    <span class="dt">Sigmae_x =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb6-17"><a href="#cb6-17"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MatrixParameter"</span>, <span class="st">"_Omitted"</span>))</span>
<span id="cb6-18"><a href="#cb6-18"></a>  )</span>
<span id="cb6-19"><a href="#cb6-19"></a>}</span></code></pre></div>
<ul>
<li>
<code>PCMSpecify.BM_drift</code> : generate default model parameters. Notice that here we obtain a singular model with 0 mean and 0 variance.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>PCMSpecify.BM_drift &lt;-<span class="st"> </span><span class="cf">function</span>(model, ...) {</span>
<span id="cb7-2"><a href="#cb7-2"></a>  spec &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="dt">X0 =</span> <span class="kw"><a href="https://rdrr.io/r/base/structure.html">structure</a></span>(<span class="fl">0.0</span>, <span class="dt">class =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'VectorParameter'</span>, <span class="st">'_Global'</span>),</span>
<span id="cb7-4"><a href="#cb7-4"></a>                   <span class="dt">description =</span> <span class="st">'trait values at the root'</span>),</span>
<span id="cb7-5"><a href="#cb7-5"></a>    <span class="dt">h_drift =</span> <span class="kw"><a href="https://rdrr.io/r/base/structure.html">structure</a></span>(<span class="fl">0.0</span>, <span class="dt">class =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'VectorParameter'</span>),</span>
<span id="cb7-6"><a href="#cb7-6"></a>                   <span class="dt">description =</span> <span class="st">'drift vector modifying the expectation'</span>),</span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="dt">Sigma_x =</span> <span class="kw"><a href="https://rdrr.io/r/base/structure.html">structure</a></span>(<span class="fl">0.0</span>, <span class="dt">class =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'MatrixParameter'</span>, <span class="st">'_UpperTriangularWithDiagonal'</span>, </span>
<span id="cb7-8"><a href="#cb7-8"></a>                    <span class="st">'_WithNonNegativeDiagonal'</span>),</span>
<span id="cb7-9"><a href="#cb7-9"></a>                        <span class="dt">description =</span> <span class="st">'Cholesky factor of the unit-time variance rate'</span>),</span>
<span id="cb7-10"><a href="#cb7-10"></a>    <span class="dt">Sigmae_x =</span> <span class="kw"><a href="https://rdrr.io/r/base/structure.html">structure</a></span>(<span class="fl">0.0</span>, <span class="dt">class =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'MatrixParameter'</span>, <span class="st">'_UpperTriangularWithDiagonal'</span>,</span>
<span id="cb7-11"><a href="#cb7-11"></a>                    <span class="st">'_WithNonNegativeDiagonal'</span>),</span>
<span id="cb7-12"><a href="#cb7-12"></a>                         <span class="dt">description =</span> <span class="st">'Upper triangular factor of the non-heritable variance </span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="st">                                or the variance of the measurement error'</span>))</span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="kw"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span>(spec) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span>(model)</span>
<span id="cb7-15"><a href="#cb7-15"></a>  <span class="cf">if</span>(<span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(spec))) <span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(spec) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'X0'</span>, <span class="st">'h_drift'</span>, <span class="st">'Sigma_x'</span>, <span class="st">'Sigmae_x'</span>)</span>
<span id="cb7-16"><a href="#cb7-16"></a>  <span class="cf">if</span>(<span class="kw"><a href="https://rdrr.io/r/base/any.html">any</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(spec, is.Transformable))) <span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(spec) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(spec), <span class="st">'_Transformable'</span>)</span>
<span id="cb7-17"><a href="#cb7-17"></a>  spec</span>
<span id="cb7-18"><a href="#cb7-18"></a>}</span></code></pre></div>
</div>
<div id="example-run" class="section level1">
<h1 class="hasAnchor">
<a href="#example-run" class="anchor"></a>Example run</h1>
<p>Now that we have defined all the code necessary for the class let us demonstrate it. After running all the above code defining the “BM_drift” class we create a model instance. We do this for a two regimes model.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>X0 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">1</span>) <span class="co">## root state</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  </span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co">## in regime a traits evolve independently</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>a.Sigma_x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1.6</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.0</span>, <span class="fl">2.4</span>, <span class="fl">0.0</span>),<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">2.0</span>))</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co">## no jumps at the end of a branch</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>a.Sigmae_x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>))</span>
<span id="cb8-7"><a href="#cb8-7"></a>a.h_drift&lt;-<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>)</span>
<span id="cb8-8"><a href="#cb8-8"></a></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co">## in regime b evolution is correlated</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>b.Sigma_x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1.6</span>, <span class="fl">0.3</span>, <span class="fl">0.3</span>), <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.0</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>),<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">2.0</span>))</span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="co">## no jumps at the end of a branch</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>b.Sigmae_x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>))</span>
<span id="cb8-13"><a href="#cb8-13"></a>b.h_drift&lt;-<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb8-14"><a href="#cb8-14"></a></span>
<span id="cb8-15"><a href="#cb8-15"></a>Sigma_x &lt;-<span class="st"> </span><span class="kw">abind</span>(a.Sigma_x, b.Sigma_x, <span class="dt">along=</span><span class="dv">3</span>, <span class="dt">new.names=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">x=</span><span class="ot">NULL</span>,<span class="dt">y=</span><span class="ot">NULL</span>,<span class="dt">regime=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'a'</span>,<span class="st">'b'</span>)))</span>
<span id="cb8-16"><a href="#cb8-16"></a>Sigmae_x &lt;-<span class="st"> </span><span class="kw">abind</span>(a.Sigmae_x,b.Sigmae_x,<span class="dt">along=</span><span class="dv">3</span>,<span class="dt">new.names=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">x=</span><span class="ot">NULL</span>,<span class="dt">y=</span><span class="ot">NULL</span>,<span class="dt">regime=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'a'</span>,<span class="st">'b'</span>)))</span>
<span id="cb8-17"><a href="#cb8-17"></a>h_drift &lt;-<span class="st"> </span><span class="kw">abind</span>(a.h_drift, b.h_drift, <span class="dt">along=</span><span class="dv">2</span>, <span class="dt">new.names=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">xy=</span><span class="ot">NULL</span>, <span class="dt">regime=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'a'</span>,<span class="st">'b'</span>)))</span>
<span id="cb8-18"><a href="#cb8-18"></a></span>
<span id="cb8-19"><a href="#cb8-19"></a>PCMBase_model_BM_drift &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCM.html">PCM</a></span>(<span class="st">"BM_drift"</span>, <span class="dt">k =</span> <span class="dv">3</span>, <span class="dt">regimes =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"a"</span>, <span class="st">"b"</span>),</span>
<span id="cb8-20"><a href="#cb8-20"></a><span class="dt">params =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">X0 =</span> X0,<span class="dt">h_drift =</span> h_drift[,,<span class="dt">drop=</span><span class="ot">FALSE</span>],</span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="dt">Sigma_x =</span> Sigma_x[,,,<span class="dt">drop=</span><span class="ot">FALSE</span>],<span class="dt">Sigmae_x =</span> Sigmae_x[,,,<span class="dt">drop=</span><span class="ot">FALSE</span>]))</span></code></pre></div>
<p>Now we simulate a random phylogeny using the same example code as in the <a href="https://venelin.github.io/PCMBase/articles/PCMBase.html">Getting started</a> guide.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># make results reproducible</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">2</span>, <span class="dt">kind =</span> <span class="st">"Mersenne-Twister"</span>, <span class="dt">normal.kind =</span> <span class="st">"Inversion"</span>)</span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co"># number of regimes</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>R &lt;-<span class="st"> </span><span class="dv">2</span></span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co"># number of extant tips</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>N &lt;-<span class="st"> </span><span class="dv">100</span></span>
<span id="cb9-9"><a href="#cb9-9"></a></span>
<span id="cb9-10"><a href="#cb9-10"></a>tree.a &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMTree.html">PCMTree</a></span>(<span class="kw">rtree</span>(<span class="dt">n=</span>N))</span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="kw"><a href="../reference/PCMTreeSetLabels.html">PCMTreeSetLabels</a></span>(tree.a)</span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="kw"><a href="../reference/PCMTreeSetPartRegimes.html">PCMTreeSetPartRegimes</a></span>(tree.a, <span class="dt">part.regime =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">`</span><span class="dt">101</span><span class="st">`</span> =<span class="st"> "a"</span>), <span class="dt">setPartition =</span> <span class="ot">TRUE</span>)</span>
<span id="cb9-13"><a href="#cb9-13"></a></span>
<span id="cb9-14"><a href="#cb9-14"></a>lstDesc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMTreeListDescendants.html">PCMTreeListDescendants</a></span>(tree.a)</span>
<span id="cb9-15"><a href="#cb9-15"></a>splitNode &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(lstDesc)[<span class="kw"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(lstDesc, length) <span class="op">&gt;</span><span class="st"> </span>N<span class="op">/</span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(lstDesc, length) <span class="op">&lt;</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>N<span class="op">/</span><span class="dv">3</span>)][<span class="dv">1</span>]</span>
<span id="cb9-16"><a href="#cb9-16"></a></span>
<span id="cb9-17"><a href="#cb9-17"></a>tree.ab &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMTreeInsertSingletons.html">PCMTreeInsertSingletons</a></span>(</span>
<span id="cb9-18"><a href="#cb9-18"></a>  tree.a, <span class="dt">nodes =</span> <span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(splitNode), </span>
<span id="cb9-19"><a href="#cb9-19"></a>  <span class="dt">positions =</span> <span class="kw"><a href="../reference/PCMTreeGetBranchLength.html">PCMTreeGetBranchLength</a></span>(tree.a, <span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(splitNode))<span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="kw"><a href="../reference/PCMTreeSetPartRegimes.html">PCMTreeSetPartRegimes</a></span>(</span>
<span id="cb9-21"><a href="#cb9-21"></a>  tree.ab,</span>
<span id="cb9-22"><a href="#cb9-22"></a>  <span class="dt">part.regime =</span> <span class="kw"><a href="https://rdrr.io/r/base/structure.html">structure</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"a"</span>, <span class="st">"b"</span>), <span class="dt">names =</span> <span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(N<span class="op">+</span><span class="dv">1</span>, splitNode))), </span>
<span id="cb9-23"><a href="#cb9-23"></a>  <span class="dt">setPartition =</span> <span class="ot">TRUE</span>)</span>
<span id="cb9-24"><a href="#cb9-24"></a></span>
<span id="cb9-25"><a href="#cb9-25"></a>palette &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMColorPalette.html">PCMColorPalette</a></span>(<span class="dv">2</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"a"</span>, <span class="st">"b"</span>))</span>
<span id="cb9-26"><a href="#cb9-26"></a></span>
<span id="cb9-27"><a href="#cb9-27"></a><span class="co"># Plot the tree with branches colored according to the regimes.</span></span>
<span id="cb9-28"><a href="#cb9-28"></a><span class="co"># The following function call works only if the ggtree package is installed, </span></span>
<span id="cb9-29"><a href="#cb9-29"></a><span class="co"># which is not on CRAN:</span></span>
<span id="cb9-30"><a href="#cb9-30"></a><span class="kw"><a href="../reference/PCMTreePlot.html">PCMTreePlot</a></span>(tree.ab) <span class="op">+</span><span class="st"> </span>ggtree<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/ggtree/man/geom_nodelab.html">geom_nodelab</a></span>(<span class="dt">size =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="PCMCreateModel_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>We simulate the traits using PCMBase’s functionality.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>mData&lt;-<span class="kw"><a href="../reference/PCMSim.html">PCMSim</a></span>(tree.ab, PCMBase_model_BM_drift, X0)[,<span class="dv">1</span><span class="op">:</span>N] <span class="co">## we only want the tip data</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co">## </span><span class="al">NOTE</span><span class="co"> that observations from different species are in the columns NOT in the rows as </span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co">## in other software</span></span></code></pre></div>
<p>Finally we calculate the likelihood under the BM with drift model.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>log_lik&lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMLik.html">PCMLik</a></span>(mData, tree.ab, PCMBase_model_BM_drift)</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(log_lik[<span class="dv">1</span>]) <span class="co">## we just want to print the log-likelihood without the attributes</span></span></code></pre></div>
<pre><code>## [1] -564.1958</code></pre>
<p>If PCMBase is used as a computational engine for some inference package, then the above code can be one way of obtaining the likelihood under a “GaussianPCM” model object. However, in such a setup it is recommended to use the mechanism of creating a likelihood function for a particular dataset through PCMCreateLikelihood. This will speed up the calculations as it avoids re-creating some internal data objects for the tree every time the likelihood value is required. One just needs to update the parameters to obtain a new likelihood value.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co">## create an vector of appropriate length to store the vectorized model parameters</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>v_param &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">double</a></span>(<span class="kw"><a href="../reference/PCMParamCount.html">PCMParamCount</a></span>(PCMBase_model_BM_drift))</span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co"># load the current model parameters into param</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="kw"><a href="../reference/PCMParamLoadOrStore.html">PCMParamLoadOrStore</a></span>(PCMBase_model_BM_drift, v_param, <span class="dt">offset=</span><span class="dv">0</span>, <span class="dt">load=</span><span class="ot">FALSE</span>)</span></code></pre></div>
<pre><code>## [1] 33</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(v_param)</span></code></pre></div>
<pre><code>##  [1] 5.0 2.0 1.0 4.0 5.0 6.0 1.0 2.0 3.0 1.6 0.0 2.4 0.0 0.0 2.0 1.6 0.3 0.3 0.3
## [20] 0.4 2.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co">## now create a likelihood function for the particular model and observed data</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>likFun &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PCMCreateLikelihood.html">PCMCreateLikelihood</a></span>(mData, tree.ab, PCMBase_model_BM_drift)</span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a>log_lik_from_likFun&lt;-<span class="kw">likFun</span>(v_param)</span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(log_lik_from_likFun[<span class="dv">1</span>])</span></code></pre></div>
<pre><code>## [1] -564.1958</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(log_lik_from_likFun[<span class="dv">1</span>]<span class="op">==</span>log_lik[<span class="dv">1</span>])</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># modify slightly the model parameters</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>v_param_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/jitter.html">jitter</a></span>(v_param)</span>
<span id="cb21-3"><a href="#cb21-3"></a></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(v_param_<span class="dv">2</span>)</span></code></pre></div>
<pre><code>##  [1]  4.9864677353  2.0052929611  1.0025535203  3.9961126941  4.9817991543
##  [6]  6.0109860596  0.9975467767  1.9800304782  2.9914517602  1.5923279410
## [11] -0.0188153804  2.3946187384 -0.0055007922  0.0087133571  2.0047812326
## [16]  1.6133759775  0.2837280674  0.2993490934  0.2829010447  0.4137024178
## [21]  2.0149764784  0.0012398628  0.0154938482 -0.0119467450  0.0025201278
## [26] -0.0002987859 -0.0184400400  0.0090499337  0.0041054207  0.0028106487
## [31]  0.0025751151  0.0059760489 -0.0174220869</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># set the new parameter vector</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>PCMBase_model_BM_drift_<span class="dv">2</span>&lt;-PCMBase_model_BM_drift</span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="kw"><a href="../reference/PCMParamLoadOrStore.html">PCMParamLoadOrStore</a></span>(PCMBase_model_BM_drift_<span class="dv">2</span>, v_param_<span class="dv">2</span>, <span class="dt">offset =</span> <span class="dv">0</span>, <span class="dt">load=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>## [1] 33</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(PCMBase_model_BM_drift_<span class="dv">2</span>)</span></code></pre></div>
<pre><code>## Brownian motion model with drift
## S3 class: BM_drift, GaussianPCM, PCM; k=3; p=33; regimes: a, b. Parameters/sub-models:
## X0 (VectorParameter, _Global, numeric; trait values at the root):
## [1] 4.986468 2.005293 1.002554
## h_drift (VectorParameter, matrix; drift vector modyfing the expectation):
##             a         b
## [1,] 3.996113 0.9975468
## [2,] 4.981799 1.9800305
## [3,] 6.010986 2.9914518
## Sigma_x (MatrixParameter, _UpperTriangularWithDiagonal, _WithNonNegativeDiagonal; Upper triangular factor of the unit-time variance rate):
## , , a
## 
##          [,1]        [,2]         [,3]
## [1,] 1.592328 -0.01881538 -0.005500792
## [2,] 0.000000  2.39461874  0.008713357
## [3,] 0.000000  0.00000000  2.004781233
## 
## , , b
## 
##          [,1]      [,2]      [,3]
## [1,] 1.613376 0.2837281 0.2829010
## [2,] 0.000000 0.2993491 0.4137024
## [3,] 0.000000 0.0000000 2.0149765
## 
## Sigmae_x (MatrixParameter, _UpperTriangularWithDiagonal, _WithNonNegativeDiagonal; Upper triangular factor of the non-heritable variance or the variance of the measurement error):
## , , a
## 
##             [,1]        [,2]          [,3]
## [1,] 0.001239863  0.01549385  0.0025201278
## [2,] 0.000000000 -0.01194675 -0.0002987859
## [3,] 0.000000000  0.00000000 -0.0184400400
## 
## , , b
## 
##             [,1]        [,2]         [,3]
## [1,] 0.009049934 0.004105421  0.002575115
## [2,] 0.000000000 0.002810649  0.005976049
## [3,] 0.000000000 0.000000000 -0.017422087
## 
## </code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>log_lik_from_likFun_<span class="dv">2</span>&lt;-<span class="kw">likFun</span>(v_param_<span class="dv">2</span>)</span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(log_lik_from_likFun_<span class="dv">2</span>[<span class="dv">1</span>])</span></code></pre></div>
<pre><code>## [1] -564.1626</code></pre>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-Mitov:2018fl">
<p>Mitov, Venelin, Krzysztof Bartoszek, Georgios Asimomitis, and Tanja Stadler. 2019. “Fast likelihood calculation for multivariate Gaussian phylogenetic models with shifts.” <em>Theor. Popul. Biol.</em>, December. <a href="https://doi.org/10.1016/j.tpb.2019.11.005">https://doi.org/10.1016/j.tpb.2019.11.005</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#brownian-motion-with-drift">Brownian motion with drift</a></li>
      <li><a href="#a-pcmbase-class-for-brownian-motion-with-drift">A PCMBase class for Brownian motion with drift</a></li>
      <li><a href="#example-run">Example run</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Venelin Mitov.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
